<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTracksy Individual User Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="sri-lanka-tax-engine.js"></script>
    <script src="behavioral-engagement-system.js"></script>
    <style>
        :root {
            --primary-color: #7c3aed;
            --secondary-color: #6d28d9;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #ffffff;
            --gray-100: #f1f5f9;
            --gray-600: #475569;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #581c87 0%, #7c2d12 100%);
            margin: 0;
            padding: 2rem;
            color: var(--dark-color);
            min-height: 100vh;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        .budget-section, .goals-section, .family-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            color: var(--dark-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .budget-item, .goal-item, .family-member {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .budget-item:last-child, .goal-item:last-child, .family-member:last-child {
            border-bottom: none;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-100);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s ease;
        }
        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        .btn-accent {
            background: var(--accent-color);
            color: var(--dark-color);
        }
        .btn-accent:hover {
            background: #f59e0b;
        }
        .voice-section {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .voice-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            font-weight: 600;
        }
        .voice-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        .expense-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .category-card {
            background: var(--gray-100);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .category-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Individual & Family Finance Dashboard</h1>
            <p>Comprehensive personal finance management for individuals and Sri Lankan families</p>
        </div>

        <div class="voice-section">
            <h3><i class="fas fa-microphone"></i> Personal Voice Commands</h3>
            <p>Use natural language for family expenses, savings goals, and personal finance tracking</p>
            <button class="voice-btn" onclick="startPersonalVoice()">
                <i class="fas fa-microphone"></i> Personal Voice Input
            </button>
            <button class="voice-btn" onclick="logFamilyExpense()">
                <i class="fas fa-home"></i> Family Expense
            </button>
            <button class="voice-btn" onclick="updateSavingsGoal()">
                <i class="fas fa-piggy-bank"></i> Savings Goal
            </button>
            <div id="voiceStatus" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="monthlyIncome">LKR 0</div>
                <div>Monthly Income</div>
                <small style="color: var(--gray-500);"><i class="fas fa-plus"></i> Add your income</small>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlyExpenses">LKR 0</div>
                <div>Monthly Expenses</div>
                <small style="color: var(--gray-500);"><i class="fas fa-plus"></i> Start tracking expenses</small>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlySavings">LKR 0</div>
                <div>Monthly Savings</div>
                <small style="color: var(--gray-500);"><i class="fas fa-piggy-bank"></i> Set savings goals</small>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="familyMembers">0</div>
                <div>Family Members</div>
                <small style="color: var(--gray-500);"><i class="fas fa-users"></i> Add family members</small>
            </div>
        </div>

        <div class="budget-section">
            <h2 class="section-title">
                <i class="fas fa-receipt"></i>
                Sri Lankan Tax Compliance Dashboard
            </h2>
            
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <div class="stat-value" id="annualIncome" style="color: #10b981;">LKR 0</div>
                    <div>Annual Income</div>
                    <small style="color: var(--gray-500);"><i class="fas fa-money-bill"></i> Income tax calculation</small>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                    <div class="stat-value" id="taxLiability" style="color: #f59e0b;">LKR 0</div>
                    <div>Tax Liability</div>
                    <small style="color: var(--gray-500);"><i class="fas fa-calculator"></i> Sri Lankan tax rates</small>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ef4444;">
                    <div class="stat-value" id="vatStatus" style="color: #ef4444;">Not Required</div>
                    <div>VAT Registration</div>
                    <small style="color: var(--gray-500);"><i class="fas fa-building"></i> LKR 12M threshold</small>
                </div>
                <div class="stat-card" style="border-left: 4px solid #7c3aed;">
                    <div class="stat-value" id="nextFiling" style="color: #7c3aed;">Mar 31</div>
                    <div>Next Tax Filing</div>
                    <small style="color: var(--gray-500);"><i class="fas fa-calendar"></i> IRD deadlines</small>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);"><i class="fas fa-calculator"></i> Income Tax Calculator</h3>
                    <div style="margin-bottom: 1rem;">
                        <label>Annual Income (LKR):</label>
                        <input type="number" id="taxIncomeInput" placeholder="Enter annual income" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;">
                    </div>
                    <button class="btn" onclick="calculatePersonalIncomeTax()" style="width: 100%;">
                        <i class="fas fa-calculator"></i> Calculate Tax
                    </button>
                    <div id="taxBreakdown" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                </div>

                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1rem; color: var(--dark-color);"><i class="fas fa-percent"></i> VAT Calculator</h3>
                    <div style="margin-bottom: 1rem;">
                        <label>Amount (LKR):</label>
                        <input type="number" id="vatAmountInput" placeholder="Enter amount" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;">
                    </div>
                    <button class="btn btn-accent" onclick="calculateVATForIndividual()" style="width: 100%;">
                        <i class="fas fa-percent"></i> Calculate VAT (18%)
                    </button>
                    <div id="vatBreakdown" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--dark-color);"><i class="fas fa-calendar-alt"></i> Tax Filing Reminders</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="font-weight: 600; color: #92400e;">Income Tax Return</div>
                        <div style="font-size: 0.9rem; color: #92400e;">Due: March 31, 2025</div>
                    </div>
                    <div style="padding: 1rem; background: #dbeafe; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 600; color: #1e40af;">Quarterly APIT</div>
                        <div style="font-size: 0.9rem; color: #1e40af;">Next: February 15</div>
                    </div>
                    <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; border-left: 4px solid #16a34a;">
                        <div style="font-weight: 600; color: #15803d;">EPF Statement</div>
                        <div style="font-size: 0.9rem; color: #15803d;">Annual review</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="budget-section">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i>
                Monthly Budget Breakdown
            </h2>
            
            <div class="expense-categories" id="expenseCategories">
                <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No Expenses Yet</h3>
                    <p>Start adding your monthly expenses to see budget breakdown</p>
                    <button class="btn" onclick="addPersonalExpense()" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i> Add First Expense
                    </button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div class="goals-section">
            <h2 class="section-title">
                <i class="fas fa-target"></i>
                Family Financial Goals
            </h2>
            <div id="goalsList">
                <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-target" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No Financial Goals Set</h3>
                    <p>Create your first savings goal to start tracking progress</p>
                    <button class="btn btn-accent" onclick="setNewGoal()" style="margin-top: 1rem;">
                        <i class="fas fa-target"></i> Set First Goal
                    </button>
                </div>
            </div>
        </div>

        <div class="family-section">
            <h2 class="section-title">
                <i class="fas fa-users"></i>
                Family Financial Members
            </h2>
            <div id="familyMembersList">
                <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No Family Members Added</h3>
                    <p>Add family members to track shared expenses and income</p>
                    <button class="btn" onclick="addFamilyMember()" style="margin-top: 1rem;">
                        <i class="fas fa-user-plus"></i> Add Family Member
                    </button>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn" onclick="addPersonalExpense()">
                <i class="fas fa-plus"></i> Add Personal Expense
            </button>
            <button class="btn btn-accent" onclick="setNewGoal()">
                <i class="fas fa-target"></i> Set New Goal
            </button>
            <button class="btn" onclick="familyBudgetPlanner()">
                <i class="fas fa-calculator"></i> Budget Planner
            </button>
            <button class="btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
        </div>
    </div>

    <script>
        const personalSamples = [
            { amount: 8500, description: 'Grocery shopping at Cargills', category: 'Food & Groceries', family: 'Shared expense' },
            { amount: 15000, description: 'Electricity bill payment', category: 'Utilities', family: 'Household' },
            { amount: 25000, description: 'Son\'s university fees', category: 'Education', family: 'Children' },
            { amount: 3500, description: 'Family dinner at restaurant', category: 'Entertainment', family: 'Family outing' },
            { amount: 12000, description: 'Medical checkup and medicines', category: 'Healthcare', family: 'Family health' },
            { amount: 6500, description: 'School transport fees', category: 'Transportation', family: 'Children' },
            { amount: 4200, description: 'Mobile phone bills for family', category: 'Communication', family: 'Shared expense' }
        ];

        const savingsGoals = [
            'Children\'s education fund', 'Emergency fund savings', 'Family vacation fund',
            'Home renovation savings', 'Car replacement fund', 'Retirement planning'
        ];

        function startPersonalVoice() {
            // Behavioral trigger: Track voice command attempts
            trackBehavioralEvent('voice_command_attempt');
            
            const status = document.getElementById('voiceStatus');
            status.innerHTML = 'üé§ Listening... Say: "Add grocery shopping 8500 rupees food category"';
            
            setTimeout(() => {
                const sample = personalSamples[Math.floor(Math.random() * personalSamples.length)];
                status.innerHTML = `
                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: left; margin-top: 1rem;">
                        <strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Personal Voice Command Recognized:</strong><br>
                        <strong>üí∞ Amount:</strong> LKR ${sample.amount.toLocaleString()}<br>
                        <strong>üìã Description:</strong> ${sample.description}<br>
                        <strong>üè† Category:</strong> ${sample.category}<br>
                        <strong>üë• Family:</strong> ${sample.family}
                    </div>
                `;
                showNotification('Personal expense added via voice!');
                
                // Behavioral trigger: Show voice tip after successful use
                showVoiceImprovementTip();
            }, 3000);
        }

        function logFamilyExpense() {
            const familyExpenses = [
                'Family groceries at supermarket', 'Children\'s school fees', 'Family medical expenses',
                'Household utility bills', 'Family entertainment outing', 'Children\'s tuition fees'
            ];
            const expense = familyExpenses[Math.floor(Math.random() * familyExpenses.length)];
            const amount = Math.floor(Math.random() * 25000) + 5000;
            
            const status = document.getElementById('voiceStatus');
            status.innerHTML = `
                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: left; margin-top: 1rem;">
                    <strong>üè† Family Expense Logged:</strong><br>
                    <strong>üí∞ Amount:</strong> LKR ${amount.toLocaleString()}<br>
                    <strong>üìã Description:</strong> ${expense}<br>
                    <strong>üë• Type:</strong> Shared Family Expense<br>
                    <strong>üìÖ Date:</strong> ${new Date().toLocaleDateString()}
                </div>
            `;
            showNotification(`Family expense logged: ${expense}`);
        }

        function updateSavingsGoal() {
            const goal = savingsGoals[Math.floor(Math.random() * savingsGoals.length)];
            const amount = Math.floor(Math.random() * 50000) + 10000;
            
            const status = document.getElementById('voiceStatus');
            status.innerHTML = `
                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: left; margin-top: 1rem;">
                    <strong>üéØ Savings Goal Updated:</strong><br>
                    <strong>üí∞ Amount:</strong> LKR ${amount.toLocaleString()}<br>
                    <strong>üéØ Goal:</strong> ${goal}<br>
                    <strong>üìà Progress:</strong> Updated successfully<br>
                    <strong>üìÖ Date:</strong> ${new Date().toLocaleDateString()}
                </div>
            `;
            showNotification(`Savings goal updated: ${goal}`);
        }

        function addPersonalExpense() {
            // Behavioral trigger: Track expense entry attempts
            trackBehavioralEvent('expense_entry_attempt');
            
            if (!checkFeatureAccess('unlimited_expenses')) {
                const todayExpenses = getTodayExpenseCount();
                if (todayExpenses >= 5) {
                    showFeatureLimitModal('voice_entries', 'You\'ve reached your daily limit of 5 expenses. Upgrade to add unlimited expenses!');
                    return;
                }
            }
            
            showPersonalExpenseForm();
            
            // Behavioral trigger: Show voice tip after manual entry
            setTimeout(() => {
                showVoiceAlternativeTip();
            }, 2000);
        }
        
        function getTodayExpenseCount() {
            const expenses = JSON.parse(localStorage.getItem('myTracksyPersonalExpenses') || '[]');
            const today = new Date().toDateString();
            return expenses.filter(expense => new Date(expense.date).toDateString() === today).length;
        }
        
        function checkFeatureAccess(feature) {
            const trialData = JSON.parse(localStorage.getItem('myTracksyTrial') || 'null');
            const subscription = JSON.parse(localStorage.getItem('myTracksySubscription') || 'null');
            
            // Check if user has active trial or subscription
            if (trialData && trialData.status === 'active') {
                const endDate = new Date(trialData.endDate);
                if (endDate > new Date()) {
                    return true; // All features unlocked during trial
                }
            }
            
            if (subscription && subscription.status === 'active') {
                return true; // All features unlocked with subscription
            }
            
            // Free tier limitations
            return false;
        }
        
        function showFeatureLimitModal(feature, message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 2.5rem;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    animation: slideInUp 0.3s ease-out;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
                ">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--warning-color);">üîí</div>
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Upgrade to Continue</h3>
                    <p style="color: var(--gray-600); margin-bottom: 2rem; line-height: 1.6;">${message}</p>
                    
                    <div style="background: var(--gray-100); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--dark-color);">Unlock with Individual Professional:</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.8rem; font-weight: 700; color: var(--primary-color);">LKR 750/month</span>
                            <span style="background: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">14-day free trial</span>
                        </div>
                        <ul style="text-align: left; color: var(--gray-700); line-height: 1.6; margin: 0;">
                            <li>‚úì Unlimited daily expenses</li>
                            <li>‚úì Advanced voice recognition</li>
                            <li>‚úì 99%+ accurate OCR scanning</li>
                            <li>‚úì Multi-language support</li>
                        </ul>
                    </div>
                    
                    <button onclick="startUpgradeFlow('individual')" style="
                        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
                        color: white;
                        border: none;
                        padding: 1rem 2rem;
                        border-radius: 12px;
                        cursor: pointer;
                        font-weight: 600;
                        margin-bottom: 1rem;
                        width: 100%;
                        font-size: 1.1rem;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    ">Start Free Trial</button>
                    
                    <button onclick="this.closest('[style*="backdrop-filter"]').remove()" style="
                        background: transparent;
                        color: var(--gray-600);
                        border: none;
                        padding: 0.75rem;
                        cursor: pointer;
                        text-decoration: underline;
                    ">Maybe Later</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.startUpgradeFlow = function(plan) {
                modal.remove();
                window.location.href = 'user-profile.html#upgrade-' + plan;
            };
        }
        
        function showPersonalExpenseForm() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 90%;
                    animation: slideInUp 0.3s ease-out;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--dark-color);">Add Personal Expense</h3>
                        <button onclick="this.closest('[style*="backdrop-filter"]').remove()" style="
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            color: var(--gray-500);
                            cursor: pointer;
                        ">&times;</button>
                    </div>
                    
                    <form id="expenseForm" onsubmit="submitExpense(event)">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Amount (LKR)</label>
                            <input type="number" id="expenseAmount" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 2px solid var(--gray-300);
                                border-radius: 8px;
                                font-size: 1rem;
                            " placeholder="Enter amount">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
                            <input type="text" id="expenseDescription" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 2px solid var(--gray-300);
                                border-radius: 8px;
                                font-size: 1rem;
                            " placeholder="What did you spend on?">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category</label>
                            <select id="expenseCategory" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 2px solid var(--gray-300);
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                                <option value="">Select category</option>
                                <option value="Food & Groceries">Food & Groceries</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <button type="submit" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 1rem 2rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            width: 100%;
                            font-size: 1.1rem;
                        ">Add Expense</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.submitExpense = function(event) {
                event.preventDefault();
                
                const amount = document.getElementById('expenseAmount').value;
                const description = document.getElementById('expenseDescription').value;
                const category = document.getElementById('expenseCategory').value;
                
                // Save expense
                const expenses = JSON.parse(localStorage.getItem('myTracksyPersonalExpenses') || '[]');
                const newExpense = {
                    id: Date.now(),
                    amount: parseFloat(amount),
                    description: description,
                    category: category,
                    date: new Date().toISOString()
                };
                
                expenses.push(newExpense);
                localStorage.setItem('myTracksyPersonalExpenses', JSON.stringify(expenses));
                
                modal.remove();
                showNotification(`Expense added: LKR ${amount} for ${description}`);
                updateExpenseDisplay();
            };
        }
        
        function updateExpenseDisplay() {
            const expenses = JSON.parse(localStorage.getItem('myTracksyPersonalExpenses') || '[]');
            const thisMonth = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                const now = new Date();
                return expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear();
            });
            
            const totalThisMonth = thisMonth.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('monthlyExpenses').textContent = `LKR ${totalThisMonth.toLocaleString()}`;
            
            // Update chart if there are expenses
            if (thisMonth.length > 0) {
                updateExpenseChart();
            }
        }

        function setNewGoal() {
            showNotification('New savings goal form opening...');
        }

        function familyBudgetPlanner() {
            showNotification('Family budget planner opening...');
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function addFamilyMember() {
            if (!checkFeatureAccess('family_management')) {
                showFeatureLimitModal('family_management', 'Family member management is a premium feature. Upgrade to manage multiple family members and shared expenses!');
                return;
            }
            
            const name = prompt('Family Member Name:');
            const role = prompt('Role/Occupation:');
            const income = prompt('Monthly Income (LKR, enter 0 if no income):');
            
            if (name && role) {
                const familyMembers = JSON.parse(localStorage.getItem('myTracksyFamilyMembers') || '[]');
                familyMembers.push({
                    id: Date.now(),
                    name: name,
                    role: role,
                    income: parseFloat(income) || 0,
                    addedAt: new Date().toISOString()
                });
                localStorage.setItem('myTracksyFamilyMembers', JSON.stringify(familyMembers));
                
                showNotification(`Family member ${name} added successfully!`, 'success');
                updateFamilyCount();
            }
        }
        
        function updateFamilyCount() {
            const familyMembers = JSON.parse(localStorage.getItem('myTracksyFamilyMembers') || '[]');
            document.getElementById('familyMembers').textContent = familyMembers.length;
        }
        
        function addPersonalExpense() {
            const amount = prompt('Expense Amount (LKR):');
            const description = prompt('What did you spend on?');
            const category = prompt('Category (Food, Transportation, etc.):');
            
            if (amount && description && category) {
                showNotification(`Expense of LKR ${amount} added successfully!`, 'success');
                updateExpenseChart();
            }
        }
        
        function updateExpenseChart() {
            // Update chart with real data when expenses are added
            const expenses = JSON.parse(localStorage.getItem('myTracksyPersonalExpenses') || '[]');
            // Chart update logic here
        }
        
        function setNewGoal() {
            const goalName = prompt('Goal Name (e.g., Emergency Fund):');
            const targetAmount = prompt('Target Amount (LKR):');
            const timeline = prompt('Timeline (e.g., 2 years):');
            
            if (goalName && targetAmount) {
                showNotification(`Goal "${goalName}" created successfully!`, 'success');
                // Save to localStorage and update display
            }
        }
        
        // Initialize expense chart with empty state
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No data yet'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Expense Distribution - Add expenses to see data'
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Initialize counts
            updateFamilyCount();
        });

        // Sri Lankan Tax Calculation Functions
        let taxEngine;
        
        function initializeTaxEngine() {
            if (!taxEngine) {
                taxEngine = new SriLankanTaxEngine();
            }
        }

        function calculatePersonalIncomeTax() {
            initializeTaxEngine();
            
            const income = parseFloat(document.getElementById('taxIncomeInput').value);
            if (!income || income <= 0) {
                showNotification('Please enter a valid income amount', 'error');
                return;
            }

            const taxCalculation = taxEngine.calculateIncomeTax(income);
            
            document.getElementById('annualIncome').textContent = `LKR ${income.toLocaleString()}`;
            document.getElementById('taxLiability').textContent = `LKR ${taxCalculation.totalTax.toLocaleString()}`;
            
            let breakdownHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">Tax Calculation Breakdown:</h4>
                    <div style="font-size: 0.9rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Annual Income:</span>
                            <span>LKR ${income.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Total Tax:</span>
                            <span style="color: #dc2626; font-weight: 600;">LKR ${taxCalculation.totalTax.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Net Income:</span>
                            <span style="color: #059669; font-weight: 600;">LKR ${taxCalculation.netIncome.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Effective Rate:</span>
                            <span>${taxCalculation.effectiveRate}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Monthly Tax:</span>
                            <span>LKR ${taxCalculation.monthlyTax.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('taxBreakdown').innerHTML = breakdownHTML;
            
            // Check VAT registration requirement
            if (income >= 12000000) {
                document.getElementById('vatStatus').textContent = 'Required';
                document.getElementById('vatStatus').style.color = '#dc2626';
            } else {
                document.getElementById('vatStatus').textContent = 'Not Required';
                document.getElementById('vatStatus').style.color = '#059669';
            }
            
            showNotification('Income tax calculated using Sri Lankan tax rates!');
        }

        function calculateVATForIndividual() {
            initializeTaxEngine();
            
            const amount = parseFloat(document.getElementById('vatAmountInput').value);
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            const vatCalculation = taxEngine.calculateVAT(amount);
            
            let breakdownHTML = `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--dark-color);">VAT Calculation (18%):</h4>
                    <div style="font-size: 0.9rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Net Amount:</span>
                            <span>LKR ${vatCalculation.netAmount.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>VAT (18%):</span>
                            <span style="color: #dc2626; font-weight: 600;">LKR ${vatCalculation.vatAmount.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 0.25rem;">
                            <span style="font-weight: 600;">Gross Amount:</span>
                            <span style="color: #059669; font-weight: 600;">LKR ${vatCalculation.grossAmount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('vatBreakdown').innerHTML = breakdownHTML;
            showNotification('VAT calculated with current Sri Lankan rate of 18%!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#fee2e2' : '#d1fae5';
            const textColor = type === 'error' ? '#991b1b' : '#065f46';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: ${textColor};
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                border: 1px solid ${type === 'error' ? '#fecaca' : '#bbf7d0'};
            `;
            notification.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // Initialize tax engine on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTaxEngine();
        });

        // Behavioral Trigger System Implementation
        function trackBehavioralEvent(eventType) {
            const events = JSON.parse(localStorage.getItem('myTracksyBehavioralEvents') || '[]');
            const event = {
                type: eventType,
                timestamp: new Date().toISOString(),
                date: new Date().toDateString()
            };
            events.push(event);
            localStorage.setItem('myTracksyBehavioralEvents', JSON.stringify(events));
            
            // Check for behavioral patterns
            checkBehavioralPatterns(eventType, events);
        }
        
        function checkBehavioralPatterns(currentEvent, events) {
            const today = new Date().toDateString();
            const todayEvents = events.filter(e => e.date === today);
            
            // Trigger: Multiple manual entries (suggest voice)
            if (currentEvent === 'expense_entry_attempt') {
                const manualEntries = todayEvents.filter(e => e.type === 'expense_entry_attempt').length;
                if (manualEntries === 3) {
                    setTimeout(() => showVoiceEfficiencyTip(), 1000);
                }
            }
            
            // Trigger: Weekly expense pattern analysis
            const weeklyExpenses = getWeeklyExpenseCount();
            if (weeklyExpenses > 20 && !hasSeenBudgetOptimizationTip()) {
                setTimeout(() => showBudgetOptimizationTip(), 2000);
            }
        }
        
        function showVoiceImprovementTip() {
            const tip = createBehavioralTip(
                'üé§ Voice Mastery Tip!',
                'Great job using voice input! Pro tip: You can say "Add LKR 2500 lunch at restaurant food category" for even faster entry.',
                'voice_improvement'
            );
            showBehavioralPopup(tip);
        }
        
        function showVoiceAlternativeTip() {
            const voiceUsage = JSON.parse(localStorage.getItem('myTracksyBehavioralEvents') || '[]')
                .filter(e => e.type === 'voice_command_attempt').length;
            
            if (voiceUsage < 3) {
                const tip = createBehavioralTip(
                    '‚ö° Speed Up Your Entry!',
                    'Did you know? Voice input is 3x faster than typing. Try saying your expense instead!',
                    'voice_alternative',
                    () => document.querySelector('.voice-btn').click()
                );
                showBehavioralPopup(tip);
            }
        }
        
        function showVoiceEfficiencyTip() {
            const tip = createBehavioralTip(
                'üöÄ Efficiency Boost Available!',
                'You\'ve added 3 expenses manually today. Voice input could save you 60% of your time!',
                'voice_efficiency',
                () => document.querySelector('.voice-btn').click()
            );
            showBehavioralPopup(tip);
        }
        
        function showBudgetOptimizationTip() {
            const tip = createBehavioralTip(
                'üìä Smart Budget Insight',
                'You\'re actively tracking expenses! Want to see where you could save LKR 5,000+ monthly?',
                'budget_optimization',
                () => familyBudgetPlanner()
            );
            showBehavioralPopup(tip);
            localStorage.setItem('myTracksySeenBudgetTip', 'true');
        }
        
        function hasSeenBudgetOptimizationTip() {
            return localStorage.getItem('myTracksySeenBudgetTip') === 'true';
        }
        
        function getWeeklyExpenseCount() {
            const expenses = JSON.parse(localStorage.getItem('myTracksyPersonalExpenses') || '[]');
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            return expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= weekAgo;
            }).length;
        }
        
        function createBehavioralTip(title, message, tipType, actionCallback = null) {
            return {
                title: title,
                message: message,
                type: tipType,
                action: actionCallback,
                timestamp: new Date().toISOString()
            };
        }
        
        function showBehavioralPopup(tip) {
            // Don't show if user has dismissed this tip type recently
            const dismissed = JSON.parse(localStorage.getItem('myTracksyDismissedTips') || '[]');
            const recentDismiss = dismissed.find(d => 
                d.type === tip.type && 
                new Date(d.timestamp) > new Date(Date.now() - 24*60*60*1000)
            );
            
            if (recentDismiss) return;
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                color: white;
                border-radius: 16px;
                padding: 2rem;
                max-width: 400px;
                width: 90%;
                z-index: 3000;
                box-shadow: 0 25px 50px rgba(0,0,0,0.3);
                animation: popupSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                text-align: center;
            `;
            
            popup.innerHTML = `
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">${tip.title.split(' ')[0]}</div>
                <h3 style="margin-bottom: 1rem; font-size: 1.3rem;">${tip.title.substring(tip.title.indexOf(' ') + 1)}</h3>
                <p style="margin-bottom: 2rem; line-height: 1.6; opacity: 0.9;">${tip.message}</p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    ${tip.action ? `
                        <button onclick="handleTipAction('${tip.type}')" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 2px solid rgba(255,255,255,0.3);
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            backdrop-filter: blur(10px);
                        ">Try It Now</button>
                    ` : ''}
                    <button onclick="dismissBehavioralTip('${tip.type}')" style="
                        background: transparent;
                        color: rgba(255,255,255,0.7);
                        border: 1px solid rgba(255,255,255,0.3);
                        padding: 0.75rem 1.5rem;
                        border-radius: 8px;
                        cursor: pointer;
                    ">Maybe Later</button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 2999;
                backdrop-filter: blur(3px);
                animation: backdropFadeIn 0.3s ease-out;
            `;
            
            backdrop.onclick = () => dismissBehavioralTip(tip.type);
            
            document.body.appendChild(backdrop);
            document.body.appendChild(popup);
            
            // Store current tip action
            window.currentTipAction = tip.action;
            window.currentTipType = tip.type;
        }
        
        function handleTipAction(tipType) {
            if (window.currentTipAction) {
                window.currentTipAction();
            }
            dismissBehavioralTip(tipType);
            
            // Track tip engagement
            trackBehavioralEvent('tip_engaged_' + tipType);
        }
        
        function dismissBehavioralTip(tipType) {
            const dismissed = JSON.parse(localStorage.getItem('myTracksyDismissedTips') || '[]');
            dismissed.push({
                type: tipType,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('myTracksyDismissedTips', JSON.stringify(dismissed));
            
            // Remove popup and backdrop
            const popup = document.querySelector('[style*="z-index: 3000"]');
            const backdrop = document.querySelector('[style*="z-index: 2999"]');
            
            if (popup) popup.remove();
            if (backdrop) backdrop.remove();
            
            // Track tip dismissal
            trackBehavioralEvent('tip_dismissed_' + tipType);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { opacity: 0; transform: translateX(100px); }
                to { opacity: 1; transform: translateX(0); }
            }
            
            @keyframes popupSlideIn {
                from { 
                    opacity: 0; 
                    transform: translate(-50%, -50%) scale(0.8); 
                }
                to { 
                    opacity: 1; 
                    transform: translate(-50%, -50%) scale(1); 
                }
            }
            
            @keyframes backdropFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>